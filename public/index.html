<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Socket.IO Chat Example</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<style>
		section{
			max-width: 1000px;
			margin: auto;
		}
		#chat{
			height: calc( 100vh - 215px);
		}
		.user{
			display: inline;
    		color: #2f16ff;
		}
	</style>
</head>
<body>
	<section>
		<div id="chat">
			
		</div>
		<p id='usersTyping'></p>
		<div class="form-group">
			<label for="exampleTextarea">Message</label>
			<textarea class="form-control" id="exampleTextarea" rows="3"></textarea>
		</div>
		<button  class="btn btn-primary" id='send'>Send</button>
		<div id="users_count"></div>
	</section>
 
</body>
</html>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.1/socket.io.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script>
var socket = io.connect('http://127.0.0.1:5000/', {reconnect: true});

var userName;

socket.on('chatHistory', function (data) {
	if(data.chat.length > 0){
		data.chat.forEach(addToChat);
	}
	userName = data.userName;
	userCount(data.users);
});

var userCount = function(count) {
	$('#users_count').html('В данный момент в чате: <span id="count">'+count+'</span>. Ваш ник: '+userName);
}

var addToChat = function(el) {
	var date = new Date(el.date);
	$('#chat').append('<div>'+date.toLocaleString("en-US")+' <p class="user">'+el.user+'</p>: '+el.msg+'</div>');
}

$('#send').on('click', function() {
	var msg = $('#exampleTextarea').val();
	socket.emit('addMessage', {'message': msg});
	$('#exampleTextarea').val('');
});

function stopTypingFun() {
	isTyping = false;
	socket.emit('userStopTyping');
}

var stopTyping, isTyping = false;

$( "#exampleTextarea" ).keyup(function() {
	clearTimeout(stopTyping);
	stopTyping = setTimeout(stopTypingFun, 2000);
})

$( "#exampleTextarea" ).keypress(function() {
	console.log(isTyping);
	if(isTyping)
		return;
	isTyping = true;
	socket.emit('userTyping');
});

socket.on( 'addMessage', function (data) {
    addToChat(data);
} );

socket.on( 'usersTyping', function (data) {
	var index = data.users.indexOf(userName);
	if (index !== -1) data.users.splice(index, 1);

	var text = data.users.join(', ')+' печатает сообщение';
	if(data.users.length > 1)
		text = data.users.join(', ')+' печатают сообщение';
    if(data.users.length < 1)
    	text = '';
    $('#usersTyping').text(text);

    console.log();
} );

socket.on( 'usersCount', function (data) {
    $('#count').html(data);
} );

</script>