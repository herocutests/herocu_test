<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Socket.IO Chat Example</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<style>
		section{
			max-width: 1000px;
			margin: auto;
		}
		#chat{
			height: calc( 100vh - 215px);
			overflow-y: scroll;
		}
		.user{
			display: inline;
			margin: 0 10px;
    		color: #2f16ff;
		}
		div{white-space: pre-line}
		.form-group {
		    margin-bottom: 0;
		}
		.message_container{
			display: flex;
			margin-top: 10px;
		}
		.message{
			word-wrap: break-word;
			max-width: 85%;
			margin-bottom: 0;
		}
		label{
			height: 24px;
			margin-bottom: 0;
    		padding-bottom: .5rem;
		}
	</style>
</head>
<body>
	<section>
		<div id="chat">
			
		</div>
		<div class="form-group">
			<label id='usersTyping'></label>
			<textarea class="form-control" id="exampleTextarea" rows="3"></textarea>
		</div>
		<div id="users_count"></div>
	</section>
 
</body>
</html>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.1/socket.io.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script>
var socket = io.connect(window.location.hostname, {reconnect: true});
//window.location.hostname
var userName;

socket.on('chatHistory', function (data) {
	if(data.chat.length > 0){
		data.chat.forEach(addToChat);
	}
	userName = data.userName;
	userCount(data.users);
});

function scrollBottom() {
	$("#chat").scrollTop($("#chat")[0].scrollHeight);
}

var userCount = function(count) {
	$('#users_count').html('В данный момент в чате: <span id="count">'+count+'</span>. Ваш ник: '+userName);
}

var addToChat = function(el) {
	var date = new Date(el.date);
	$('#chat').append('<div class="message_container">'+date.toLocaleString(["ru-RU"], {hour: '2-digit', minute:'2-digit'})+' <p class="user">'+el.user+': </p><p class="message">'+el.msg+'</p></div>');
	scrollBottom();
}

function sendForm() {
	var msg = $('#exampleTextarea').val();
	socket.emit('addMessage', {'message': msg});
	$('#exampleTextarea').val('');
}

function stopTypingFun() {
	isTyping = false;
	socket.emit('userStopTyping');
}

var stopTyping, isTyping = false;

$( "#exampleTextarea" ).keyup(function() {
	clearTimeout(stopTyping);
	stopTyping = setTimeout(stopTypingFun, 1000);
})

$( "#exampleTextarea" ).keypress(function(e) {
	if(!e.ctrlKey && e.keyCode == 13){
		e.preventDefault();
		sendForm();
		return;
	}
	if((e.keyCode == 10 || e.keyCode == 13) && e.ctrlKey)
		$('#exampleTextarea').val($('#exampleTextarea').val()+'\r\n');
	if(isTyping)
		return;
	isTyping = true;
	socket.emit('userTyping');
});

socket.on( 'addMessage', function (data) {
    addToChat(data);
} );

socket.on( 'usersTyping', function (data) {
	var index = data.users.indexOf(userName);
	if (index !== -1) data.users.splice(index, 1);

	var text = data.users.join(', ')+' печатает сообщение';
	if(data.users.length > 1)
		text = data.users.join(', ')+' печатают сообщение';
    if(data.users.length < 1)
    	text = '';
    $('#usersTyping').text(text);
} );

socket.on( 'usersCount', function (data) {
    $('#count').html(data);
} );

</script>