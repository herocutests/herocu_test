<!doctype html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Socket.IO Chat Example</title>
	<link href="reset.css" rel="stylesheet">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<style>
		section{
			max-width: 1000px;
			margin: auto;
		}
		#chat{
			height: calc( 100vh - 190px);
		    margin-bottom: 20px;
		    overflow-y: scroll;
		}
		.user{
			display: inline;
			margin: 0 10px;
			color: #2f16ff;
		}
		div{white-space: pre-line}
		.form-group {
			margin-bottom: 0;
		}
		.message_container{
			display: flex;
			padding-top: 10px;
			cursor: default;
			background-color: transparent;
    		transition: all ease 2s;
		}
		.message{
			word-wrap: break-word;
		    max-width: calc( 100% - 54px);
		    margin-bottom: 0;
		    padding-left: 54px;
		}
		.username{
			position: absolute;
			width: 100%;
			height: 100%;
			top: 0;
			background-color: #3f4040e6;
			text-align: center;
		}
		.username h1{
		    font-size: 31px;
		    margin-top: calc((100vh - 200px) / 2);
		    color: white;
		    margin-bottom: 0;
		}
		.username input{
			width: 300px;
			background: none;
			border: none;
			border-bottom: 1px solid white;
			color: white;
			text-align: center;
		}
		input:focus,
		select:focus,
		textarea:focus,
		button:focus {
		    outline: none;
		}
		.date_name{
			min-width: 200px;
		}
		#usersTyping{
			margin-bottom: 0;
			position: absolute;
			top: calc( 100vh - 182px);
		}
		.userWarning{
			color: #ff8181;
			display: none;
		}
		.newUser{
			text-align: center;
    		color: #ababab;
		}
		.unreadMessages {
		    background-color: #e4e3e3;
		}
	</style>
</head>
<body>
	<section>
		<div id="chat">
		</div>
		<p id='usersTyping'></p>
		<div class="form-group">
			<textarea class="form-control" id="exampleTextarea" rows="3"></textarea>
		</div>
		<div id="users_count"></div>
	</section>
	<div class="username">
		<h1>Введите имя</h1>
		<input type="text" id='nickname'>
		<p class='userWarning'></p>
	</div>
</body>
</html>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.1/socket.io.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script>

$(function(){  
  $('<audio id="chatAudio"><source src="/src/notify.ogg" type="audio/ogg"><source src="/src/notify.mp3" type="audio/mpeg"><source src="/src/notify.wav" type="audio/wav"></audio>').appendTo('body');
})
var socket = io.connect(window.location.hostname, {reconnect: true});
//window.location.hostname
var userName = '', lastUsernameMessage, users = [], changeMessage, uid, chatLoaded = false;

socket.on('loginUser', function () {
	userName = '';
	$('.username').css('display', 'block');
});

socket.on('chatHistory', function (data) {
	users = data.userList;
	if(chatLoaded === true)
		return;
	chatLoaded = true;
	if(data.chat.length > 0){
		data.chat.forEach(function(el, i) {
			addToChat(el, i);
		});
	}
	userCount(data.users);
});

socket.on('existUsername', function () {
	$('.userWarning').css('display', 'block');
	$('.userWarning').text('Такой пользователь уже есть');
	userName = '';
});

socket.on('userLoggedIn', function (data) {
	$('.userWarning').css('display', 'none');
	$('.username').css('display', 'none');
	userName = $('#nickname').val();
	uid = data.uid;
	userCount(data.count);
});

socket.on('incorrectUsername', function (data) {
	$('.userWarning').css('display', 'block');
	$('.userWarning').text('Недопустимое имя');
	userName = '';
});

socket.on('chatNewUser', function (data) {
	users = data.usersList;
	chatAppend('<div class="newUser"> К чату присоединился '+data.user+'</div>');
});

socket.on('chatGoneUser', function (data) {
	chatAppend('<div class="newUser"> Чат покинул '+data+'</div>');
});

function chatAppend(text){
	$('#chat').append(text);
	scrollBottom();
}

function scrollBottom() {
	$("#chat").scrollTop($("#chat")[0].scrollHeight);
}

var userCount = function(count) {
	var text = 'В данный момент в чате: <span id="count">'+count+'</span>.';
	if(userName !== '')
		text += ' Ваш ник: '+userName;
	$('#users_count').html(text);
}

var addToChat = function(el, id) {
	if(el.user != lastUsernameMessage)
		chatAppend('<div class="message_container '+(!window.isTabActive ? 'unreadMessages' : '')+'"><div class="date_name">'+getTime(el.date)+' <p class="user" style="color:'+users[el.user].color+'">'+users[el.user].name+': </p></div></div>');
	chatAppend('<div class="message_container editMessage '+(!window.isTabActive ? 'unreadMessages' : '')+'" mid="'+id+'" '+(el.user == uid ? 'canEdit="true"' : 'canEdit="false"')+'><p class="message">'+el.msg+'</p></div>');
	lastUsernameMessage = el.user;
	if(!window.isTabActive)
		$('#chatAudio').get(0).play();
}


function getTime(time) {
	var time = new Date(time);
	return ("0" + time.getHours()).slice(-2)   + ":" +  ("0" + time.getMinutes()).slice(-2) + ":" ;
}

$(document).on('click', '.editMessage', function(){ 
    if($(this).attr('canEdit') == "false")
    	return;
    changeMessage = $(this).attr('mid');
    $('#exampleTextarea').val($(this).find(".message").text());
});

var isTabActive = true;

window.onfocus = function () { 
	isTabActive = true; 
	$('.message_container').removeClass('unreadMessages');
}; 

window.onblur = function () { 
	isTabActive = false; 
}; 

function sendForm() {
	var msg = $('#exampleTextarea').val();
	socket.emit('addMessage', {'message': msg});
	$('#exampleTextarea').val('');
}

function stopTypingFun() {
	isTyping = false;
	socket.emit('userStopTyping');
}

var stopTyping, isTyping = false;

$( "#exampleTextarea" ).keyup(function() {
	clearTimeout(stopTyping);
	stopTyping = setTimeout(stopTypingFun, 3000);
})

$('#nickname').keypress(function(e) {
	if(e.keyCode == 13){
		e.preventDefault();
		var msg = $('#nickname').val();
		socket.emit('userName', {'user': msg});
		return;
	}
})

$( "#exampleTextarea" ).keypress(function(e) {
	if(!e.ctrlKey && e.keyCode == 13){
		e.preventDefault();
		sendForm();
		return;
	}
	if((e.keyCode == 10 || e.keyCode == 13) && e.ctrlKey)
		$('#exampleTextarea').val($('#exampleTextarea').val()+'\r\n');
	if(isTyping)
		return;
	isTyping = true;
	socket.emit('userTyping');
});

socket.on( 'addMessage', function (data) {
	addToChat(data.message, data.id);
} );

socket.on( 'usersTyping', function (data) {
	var index = data.users.indexOf(userName);
	if (index !== -1) data.users.splice(index, 1);

	var text = data.users.join(', ')+' печатает сообщение:';
	if(data.users.length > 1)
		text = data.users.join(', ')+' печатают сообщение:';
	if(data.users.length < 1)
		text = '';
	$('#usersTyping').text(text);
} );

socket.on( 'usersCount', function (data) {
	$('#count').html(data);
} );

</script>